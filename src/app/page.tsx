import { prisma } from "@/lib/db";
import { auth } from "@/lib/auth";
import { getSiteSettings } from "@/lib/settings";
import { cn } from "@/lib/utils";
import { HeroSlider } from "@/components/storefront/hero-slider";
import { FeaturedProducts } from "@/components/storefront/featured-products";
import { CategorySectionModern } from "@/components/storefront/category-section-modern";
import { CategorySidebar } from "@/components/storefront/category-sidebar";
import { CategorySidebarModern } from "@/components/storefront/category-sidebar-modern";
import { StorefrontHeader } from "@/components/storefront/header";
import { StorefrontFooter } from "@/components/storefront/footer";
import Link from "next/link";
import Image from "next/image";
import { Button } from "@/components/ui/button";
import { ArrowRight, Truck, Shield, HeadphonesIcon } from "lucide-react";

export const dynamic = 'force-dynamic';


async function getHomeData() {
  const [sliders, featuredProducts, newProducts, bestSellers, categories, sidebarCategories, headerCategories, policies, banners] =
    await Promise.all([
      prisma.slider.findMany({
        where: { isActive: true },
        orderBy: { order: "asc" },
      }),
      prisma.product.findMany({
        where: { isActive: true, isFeatured: true },
        include: { category: true, brand: true },
        take: 8,
      }),
      prisma.product.findMany({
        where: { isActive: true, isNew: true },
        include: { category: true, brand: true },
        take: 8,
      }),
      prisma.product.findMany({
        where: { isActive: true, isBestSeller: true },
        include: { category: true, brand: true },
        take: 8,
      }),
      prisma.category.findMany({
        where: { isActive: true, isFeatured: true },
        orderBy: { order: "asc" },
        take: 5,
      }),
      // Sidebar categories (all active top-level)
      prisma.category.findMany({
        where: {
          isActive: true,
          parentId: "cml9exnw20009orv864or2ni2"
        },
        orderBy: { order: "asc" },
        select: {
          id: true,
          name: true,
          slug: true,
          children: {
            where: { isActive: true },
            select: { id: true, name: true, slug: true },
            orderBy: { order: "asc" }
          }
        }
      }),
      // Header categories...
      (async () => {
        // ... implementation skipped for brevity, keeping existing logic
        let cats = await prisma.category.findMany({
          where: { isActive: true, isInHeader: true },
          orderBy: [{ headerOrder: "asc" }, { order: "asc" }],
          select: {
            id: true, name: true, slug: true, isInHeader: true,
            children: {
              where: { isActive: true },
              select: { id: true, name: true, slug: true },
              orderBy: { order: "asc" }
            }
          }
        });
        if (cats.length === 0) {
          // fallback logic
          cats = await prisma.category.findMany({ where: { isActive: true, parentId: null }, take: 10, select: { id: true, name: true, slug: true, isInHeader: true, children: { select: { id: true, name: true, slug: true } } } });
        }
        return cats;
      })(),
      prisma.policy.findMany({
        select: { slug: true, title: true }
      }),
      prisma.banner.findMany({
        where: { isActive: true },
        orderBy: { order: "asc" },
      })
    ]);

  const transformProduct = (product: any) => ({
    ...product,
    listPrice: Number(product.listPrice),
    salePrice: product.salePrice ? Number(product.salePrice) : null,
    trendyolPrice: product.trendyolPrice ? Number(product.trendyolPrice) : null,
    n11Price: product.n11Price ? Number(product.n11Price) : null,
    hepsiburadaPrice: product.hepsiburadaPrice ? Number(product.hepsiburadaPrice) : null,
    createdAt: product.createdAt.toISOString(),
    updatedAt: product.updatedAt.toISOString(),
  });

  const transformCategory = (category: any) => ({
    ...category,
    createdAt: category.createdAt.toISOString(),
  });

  const transformSlider = (slider: any) => ({
    ...slider,
    createdAt: slider.createdAt.toISOString(),
  });

  const transformBanner = (banner: any) => ({
    ...banner,
    createdAt: banner.createdAt.toISOString(),
    updatedAt: banner.updatedAt.toISOString(),
  });

  return {
    sliders: sliders.map(transformSlider),
    featuredProducts: featuredProducts.map(transformProduct),
    newProducts: newProducts.map(transformProduct),
    bestSellers: bestSellers.map(transformProduct),
    categories: categories.map(transformCategory),
    sidebarCategories: sidebarCategories,
    headerCategories: headerCategories,
    policies: policies,
    banners: banners.map(transformBanner),
  };
}

export default async function HomePage() {
  const session = await auth();
  const data = await getHomeData();
  const settings = await getSiteSettings();
  const discountRate = session?.user?.discountRate || 0;
  const isDealer =
    session?.user?.role === "DEALER" && session?.user?.status === "APPROVED";

  return (
    <div className="min-h-screen flex flex-col bg-gray-50 dark:bg-gray-900">
      <StorefrontHeader
        user={session?.user}
        logoUrl={settings.logoUrl}
        siteName={settings.siteName}
        categories={data.headerCategories}
        sidebarCategories={data.sidebarCategories}
        phone={settings.phone}
        facebookUrl={settings.facebookUrl}
        instagramUrl={settings.instagramUrl}
        twitterUrl={settings.twitterUrl}
        linkedinUrl={settings.linkedinUrl}
      />
      <main className="flex-1">
        <div className="container mx-auto px-4 py-8">
          <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
            {/* Left Sidebar - Desktop Only */}
            <aside className="hidden lg:block lg:col-span-1 h-fit sticky top-24 z-30">
              <CategorySidebarModern categories={data.sidebarCategories} />
            </aside>

            {/* Main Content */}
            <div className="lg:col-span-3 space-y-12">
              {/* Hero Slider */}
              <div className="rounded-xl overflow-hidden shadow-sm">
                <HeroSlider sliders={data.sliders} />
              </div>



              {/* Features - Modern Frameless Design */}
              <section className="grid gap-2 grid-cols-3 py-4 border-y border-gray-100 dark:border-gray-800">
                <div className="flex flex-col md:flex-row items-center justify-center gap-2 md:gap-3 group text-center md:text-left">
                  <div className="w-10 h-10 bg-blue-50 dark:bg-blue-900/20 rounded-xl flex items-center justify-center transition-transform duration-300 group-hover:scale-110 group-hover:rotate-3 shrink-0">
                    <Truck className="h-5 w-5 text-blue-600" />
                  </div>
                  <div>
                    <h3 className="font-bold text-gray-900 dark:text-white text-[10px] md:text-sm leading-tight">
                      Hızlı Teslimat
                    </h3>
                    <p className="hidden md:block text-xs text-gray-500">Aynı gün kargo imkanı</p>
                  </div>
                </div>

                <div className="flex flex-col md:flex-row items-center justify-center gap-2 md:gap-3 group text-center md:text-left">
                  <div className="w-10 h-10 bg-green-50 dark:bg-green-900/20 rounded-xl flex items-center justify-center transition-transform duration-300 group-hover:scale-110 group-hover:-rotate-3 shrink-0">
                    <Shield className="h-5 w-5 text-green-600" />
                  </div>
                  <div>
                    <h3 className="font-bold text-gray-900 dark:text-white text-[10px] md:text-sm leading-tight">
                      Güvenli Ödeme
                    </h3>
                    <p className="hidden md:block text-xs text-gray-500">256-bit SSL sertifikası</p>
                  </div>
                </div>

                <div className="flex flex-col md:flex-row items-center justify-center gap-2 md:gap-3 group text-center md:text-left">
                  <div className="w-10 h-10 bg-purple-50 dark:bg-purple-900/20 rounded-xl flex items-center justify-center transition-transform duration-300 group-hover:scale-110 group-hover:rotate-3 shrink-0">
                    <HeadphonesIcon className="h-5 w-5 text-purple-600" />
                  </div>
                  <div>
                    <h3 className="font-bold text-gray-900 dark:text-white text-[10px] md:text-sm leading-tight">
                      7/24 Destek
                    </h3>
                    <p className="hidden md:block text-xs text-gray-500">Müşteri hizmetleri desteği</p>
                  </div>
                </div>
              </section>
              {/* Categories */}
              {data.categories.length > 0 && (
                <CategorySectionModern categories={data.categories} />
              )}

              {/* Featured Products */}
              {data.featuredProducts.length > 0 && (
                <FeaturedProducts
                  title="Öne Çıkan Ürünler"
                  products={data.featuredProducts}
                  discountRate={discountRate}
                  isDealer={isDealer}
                  variant="featured"
                />
              )}

              {/* New Products */}
              {data.newProducts.length > 0 && (
                <FeaturedProducts
                  title="Yeni Ürünler"
                  products={data.newProducts}
                  discountRate={discountRate}
                  isDealer={isDealer}
                  badge="Yeni"
                  variant="new"
                />
              )}

              {/* Best Sellers */}
              {data.bestSellers.length > 0 && (
                <FeaturedProducts
                  title="Çok Satanlar"
                  products={data.bestSellers}
                  discountRate={discountRate}
                  isDealer={isDealer}
                  badge="Popüler"
                  variant="bestseller"
                />
              )}
            </div>
          </div>

          {/* Bottom Banners */}
          {data.banners.length > 0 && (
            <section className="mt-12 mb-8">
              <div className="grid gap-4 grid-cols-1 md:grid-cols-3">
                {data.banners.map((banner: any) => (
                  <Link
                    key={banner.id}
                    href={banner.linkUrl || "#"}
                    className={cn(
                      "relative h-48 md:h-64 rounded-2xl overflow-hidden group block",
                      !banner.linkUrl && "cursor-default"
                    )}
                  >
                    <Image
                      src={banner.imageUrl}
                      alt={banner.title || "Banner"}
                      fill
                      className="object-cover transition-transform duration-500 group-hover:scale-110"
                    />
                    <div className="absolute inset-0 bg-black/20 group-hover:bg-black/10 transition-colors" />
                    {banner.title && (
                      <div className="absolute bottom-4 left-4 right-4 z-10">
                        <h3 className="text-white font-bold text-lg drop-shadow-md">{banner.title}</h3>
                      </div>
                    )}
                  </Link>
                ))}
              </div>
            </section>
          )}
        </div>
      </main>
      <StorefrontFooter settings={settings} policies={data.policies} />
    </div>
  );
}
